name: release

on:
  workflow_dispatch:
    inputs:
      tag:
        description: "Tag to release (vX.Y.Z)"
        required: true
        type: string
  push:
    tags:
      - "v*"

concurrency:
  group: release-${{ github.event_name == 'workflow_dispatch' && github.event.inputs.tag || github.ref }}
  cancel-in-progress: true

permissions:
  contents: read

env:
  RELEASE_TAG: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.tag || github.ref_name }}

jobs:
  build:
    name: Build (${{ matrix.os }} / ${{ matrix.arch }})
    runs-on: ${{ matrix.runner }}
    strategy:
      fail-fast: false
      matrix:
        include:
          # macOS builds (native runners per arch)
          - { os: 'macos', runner: 'macos-14', arch: 'arm64', goos: 'darwin', goarch: 'arm64' }
          - { os: 'macos', runner: 'macos-15-intel', arch: 'x64', goos: 'darwin', goarch: 'amd64' }
          # Ubuntu/Linux builds (native runners per arch)
          - { os: 'linux', runner: 'ubuntu-latest', arch: 'x86_64', goos: 'linux', goarch: 'amd64' }
          - { os: 'linux', runner: 'ubuntu-24.04-arm64', arch: 'arm64', goos: 'linux', goarch: 'arm64' }
          # Windows builds
          - { os: 'windows', runner: 'windows-latest', arch: 'x64', goos: 'windows', goarch: 'amd64' }

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
          cache-dependency-path: |
            apps/web/package-lock.json
            apps/desktop/package-lock.json

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.21"
          cache: true
          cache-dependency-path: services/api/go.sum

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Rust cache
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: |
            apps/desktop/src-tauri -> target

      - name: Install Linux dependencies
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libwebkit2gtk-4.1-dev \
            libayatana-appindicator3-dev \
            librsvg2-dev \
            patchelf

      - name: Install frontend deps
        working-directory: apps/web
        run: npm ci

      - name: Install desktop deps
        working-directory: apps/desktop
        run: npm ci

      - name: Build backend (mac/linux)
        if: runner.os != 'Windows'
        env:
          GOOS: ${{ matrix.goos }}
          GOARCH: ${{ matrix.goarch }}
        run: scripts/build-backend.sh

      - name: Build backend (windows)
        if: runner.os == 'Windows'
        env:
          GOOS: ${{ matrix.goos }}
          GOARCH: ${{ matrix.goarch }}
        shell: pwsh
        run: scripts/build-backend.ps1

      - name: Generate backend binary checksum (mac/linux)
        if: runner.os != 'Windows'
        shell: bash
        run: |
          set -euo pipefail
          cd apps/desktop/src-tauri/bin
          if [[ "${RUNNER_OS}" == "macOS" ]]; then
            for f in ionicx-api*; do
              shasum -a 256 "$f" > "${f}.sha256"
            done
          else
            for f in ionicx-api*; do
              sha256sum "$f" > "${f}.sha256"
            done
          fi
          ls -la

      - name: Generate backend binary checksum (windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          cd apps/desktop/src-tauri/bin
          foreach ($file in Get-ChildItem -Filter "ionicx-api*") {
            $hash = (Get-FileHash -Path $file.FullName -Algorithm SHA256).Hash
            Set-Content -Path "$($file.Name).sha256" -Value "$hash  $($file.Name)"
          }
          Get-ChildItem

      - name: Verify backend binary (mac/linux)
        if: runner.os != 'Windows'
        shell: bash
        run: |
          BIN_DIR="apps/desktop/src-tauri/bin"
          if [[ ! -f "$BIN_DIR/ionicx-api" ]] && [[ ! -f "$BIN_DIR/ionicx-api"* ]]; then
            echo "ERROR: Backend binary not found in $BIN_DIR"
            ls -la "$BIN_DIR" || echo "Directory does not exist"
            exit 1
          fi
          echo "‚úì Backend binary verified"
          ls -la "$BIN_DIR/ionicx-api"*

      - name: Verify backend binary (windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          if (-not (Test-Path "apps/desktop/src-tauri/bin/ionicx-api.exe")) {
            Write-Error "Backend binary not found at apps/desktop/src-tauri/bin/ionicx-api.exe"
            exit 1
          }
          Write-Host "Backend binary verified"

      - name: Build frontend
        working-directory: apps/web
        run: npm run build

      - name: Build desktop
        working-directory: apps/desktop
        run: npm run tauri build

      # Optional macOS signing + notarization (requires secrets)
      # - name: Import signing cert
      #   if: runner.os == 'macOS'
      #   uses: apple-actions/import-codesign-certs@v3
      #   with:
      #     p12-file-base64: ${{ secrets.MACOS_CERT_P12 }}
      #     p12-password: ${{ secrets.MACOS_CERT_PASSWORD }}
      # - name: Notarize
      #   if: runner.os == 'macOS'
      #   run: |
      #     xcrun notarytool submit <path-to-dmg> \
      #       --apple-id "${{ secrets.MACOS_APPLE_ID }}" \
      #       --team-id "${{ secrets.MACOS_TEAM_ID }}" \
      #       --password "${{ secrets.MACOS_APP_SPECIFIC_PASSWORD }}" \
      #       --wait

      # Optional Windows code signing (requires secrets)
      # - name: Sign Windows artifacts
      #   if: runner.os == 'Windows'
      #   shell: pwsh
      #   run: |
      #     signtool.exe sign /fd sha256 /a /f $env:WINDOWS_CERT_PFX /p $env:WINDOWS_CERT_PASSWORD <path-to-msi-or-exe>

      - name: Stage release assets (macOS/Linux)
        if: runner.os != 'Windows'
        shell: bash
        run: |
          set -euo pipefail
          
          OUT_DIR="release-assets"
          BUNDLE_DIR="apps/desktop/src-tauri/target/release/bundle"
          mkdir -p "$OUT_DIR"
          
          # Detect actual architecture
          if [[ "${RUNNER_OS}" == "macOS" ]]; then
            ARCH="${{ matrix.arch }}"
            OS_LABEL="macos"
            
            # Copy DMG files with consistent naming
            if [[ -f "$BUNDLE_DIR"/dmg/*.dmg ]]; then
              for f in "$BUNDLE_DIR"/dmg/*.dmg; do
                filename=$(basename "$f")
                cp "$f" "$OUT_DIR/ionicx-${OS_LABEL}-${ARCH}.dmg"
                # Generate checksum
                (cd "$OUT_DIR" && shasum -a 256 "ionicx-${OS_LABEL}-${ARCH}.dmg" > "ionicx-${OS_LABEL}-${ARCH}.dmg.sha256")
                echo "Staged: ionicx-${OS_LABEL}-${ARCH}.dmg"
              done
            fi
            
            # Copy app.zip files
            if [[ -f "$BUNDLE_DIR"/macos/*.app.zip ]]; then
              for f in "$BUNDLE_DIR"/macos/*.app.zip; do
                cp "$f" "$OUT_DIR/ionicx-${OS_LABEL}-${ARCH}.app.zip"
                (cd "$OUT_DIR" && shasum -a 256 "ionicx-${OS_LABEL}-${ARCH}.app.zip" > "ionicx-${OS_LABEL}-${ARCH}.app.zip.sha256")
                echo "Staged: ionicx-${OS_LABEL}-${ARCH}.app.zip"
              done
            fi
          fi
          
          if [[ "${RUNNER_OS}" == "Linux" ]]; then
            ARCH="${{ matrix.arch }}"
            OS_LABEL="linux"
            
            # AppImage
            if [[ -f "$BUNDLE_DIR"/appimage/*.AppImage ]]; then
              for f in "$BUNDLE_DIR"/appimage/*.AppImage; do
                cp "$f" "$OUT_DIR/ionicx-${OS_LABEL}-${ARCH}.AppImage"
                chmod +x "$OUT_DIR/ionicx-${OS_LABEL}-${ARCH}.AppImage"
                (cd "$OUT_DIR" && sha256sum "ionicx-${OS_LABEL}-${ARCH}.AppImage" > "ionicx-${OS_LABEL}-${ARCH}.AppImage.sha256")
                echo "Staged: ionicx-${OS_LABEL}-${ARCH}.AppImage"
              done
            fi
            
            # DEB
            if [[ -f "$BUNDLE_DIR"/deb/*.deb ]]; then
              for f in "$BUNDLE_DIR"/deb/*.deb; do
                cp "$f" "$OUT_DIR/ionicx-${OS_LABEL}-${ARCH}.deb"
                (cd "$OUT_DIR" && sha256sum "ionicx-${OS_LABEL}-${ARCH}.deb" > "ionicx-${OS_LABEL}-${ARCH}.deb.sha256")
                echo "Staged: ionicx-${OS_LABEL}-${ARCH}.deb"
              done
            fi
            
            # RPM
            if [[ -f "$BUNDLE_DIR"/rpm/*.rpm ]]; then
              for f in "$BUNDLE_DIR"/rpm/*.rpm; do
                cp "$f" "$OUT_DIR/ionicx-${OS_LABEL}-${ARCH}.rpm"
                (cd "$OUT_DIR" && sha256sum "ionicx-${OS_LABEL}-${ARCH}.rpm" > "ionicx-${OS_LABEL}-${ARCH}.rpm.sha256")
                echo "Staged: ionicx-${OS_LABEL}-${ARCH}.rpm"
              done
            fi
          fi
          
          # Validate assets exist
          count=$(ls -1 "$OUT_DIR"/*.{dmg,deb,rpm,AppImage,app.zip} 2>/dev/null | wc -l | tr -d ' ')
          if [[ "$count" -eq 0 ]]; then
            echo "ERROR: No release assets found in $BUNDLE_DIR"
            echo "Contents of $BUNDLE_DIR:"
            find "$BUNDLE_DIR" -type f -name "*.dmg" -o -name "*.deb" -o -name "*.rpm" -o -name "*.AppImage" -o -name "*.app.zip" | head -20
            exit 1
          fi
          
          echo "‚úì Successfully staged $count assets"
          ls -lah "$OUT_DIR"

      - name: Stage release assets (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          $outDir = "release-assets"
          $bundleDir = "apps/desktop/src-tauri/target/release/bundle"
          $arch = "${{ matrix.arch }}"
          $osLabel = "windows"
          
          New-Item -ItemType Directory -Force -Path $outDir | Out-Null
          
          # MSI
          $msiFiles = Get-ChildItem -Path (Join-Path $bundleDir "msi") -Filter *.msi -ErrorAction SilentlyContinue
          foreach ($msi in $msiFiles) {
            $destName = "ionicx-${osLabel}-${arch}.msi"
            $dest = Join-Path $outDir $destName
            Copy-Item $msi.FullName $dest -Force
            
            # Generate checksum
            $hash = (Get-FileHash -Path $dest -Algorithm SHA256).Hash
            Set-Content -Path "${dest}.sha256" -Value "$hash  $destName"
            Write-Host "Staged: $destName"
          }
          
          # NSIS EXE
          $exeFiles = Get-ChildItem -Path (Join-Path $bundleDir "nsis") -Filter *.exe -ErrorAction SilentlyContinue
          foreach ($exe in $exeFiles) {
            $destName = "ionicx-${osLabel}-${arch}.exe"
            $dest = Join-Path $outDir $destName
            Copy-Item $exe.FullName $dest -Force
            
            # Generate checksum
            $hash = (Get-FileHash -Path $dest -Algorithm SHA256).Hash
            Set-Content -Path "${dest}.sha256" -Value "$hash  $destName"
            Write-Host "Staged: $destName"
          }
          
          # Validate assets
          $count = (Get-ChildItem -Path $outDir -File -Filter "ionicx-*" -ErrorAction SilentlyContinue | Measure-Object).Count
          if ($count -eq 0) {
            Write-Error "No release assets found"
            Write-Host "Contents of bundle directory:"
            Get-ChildItem -Path $bundleDir -Recurse | Select-Object FullName
            exit 1
          }
          
          Write-Host "‚úì Successfully staged $count assets"
          Get-ChildItem -Path $outDir | ForEach-Object { Write-Host $_.FullName }

      - name: Validate release assets before upload
        shell: bash
        run: |
          set -euo pipefail
          echo "üìã Validating release assets..."
          
          if [[ ! -d "release-assets" ]]; then
            echo "ERROR: release-assets directory not found"
            exit 1
          fi
          
          count=$(ls -1 release-assets/ | wc -l)
          if [[ $count -eq 0 ]]; then
            echo "ERROR: No files in release-assets"
            exit 1
          fi
          
          # Validate file sizes
          echo "üì¶ Asset summary:"
          du -sh release-assets/*
          
          # Verify checksums exist
          echo "‚úì Checksums:"
          find release-assets -name "*.sha256" | head -10
          
          echo "‚úì Ready to upload $count artifacts"

      - name: Upload installers
        uses: actions/upload-artifact@v4
        with:
          name: ionicx-${{ matrix.os }}-${{ matrix.arch }}
          path: release-assets/*
          retention-days: 30
          if-no-files-found: error

  release:
    name: Release
    runs-on: ubuntu-latest
    needs: build
    permissions:
      contents: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          path: release-assets
          merge-multiple: true

      - name: Organize and validate assets
        shell: bash
        run: |
          set -euo pipefail
          echo "üì¶ Downloaded artifacts:"
          ls -lah release-assets/ || true
          
          # Count assets by OS
          echo ""
          echo "üìä Assets by platform:"
          for os in macos linux windows; do
            count=$(find release-assets -name "*$os*" -type f ! -name "*.sha256" | wc -l)
            if [[ $count -gt 0 ]]; then
              echo "  $os: $count assets"
            fi
          done
          
          # Verify integrity
          echo ""
          echo "‚úì Verifying integrity..."
          cd release-assets
          for f in *.sha256; do
            if [[ -f "$f" ]]; then
              base="${f%.sha256}"
              if [[ -f "$base" ]]; then
                if sha256sum -c "$f" > /dev/null 2>&1; then
                  echo "  ‚úì $base"
                else
                  echo "  ‚ùå FAILED: $base"
                  exit 1
                fi
              fi
            fi
          done
          cd ..

      - name: Generate checksum manifest
        run: |
          cd release-assets
          cat > CHECKSUMS.txt << EOF
          # ionicX ${{ env.RELEASE_TAG }} - Checksums
          # Generated: $(date -u)
          
          ## macOS
          EOF
          
          find . -name "ionicx-macos-*" -not -name "*.sha256" | sort >> CHECKSUMS.txt
          echo "" >> CHECKSUMS.txt
          echo "## Linux" >> CHECKSUMS.txt
          find . -name "ionicx-linux-*" -not -name "*.sha256" | sort >> CHECKSUMS.txt
          echo "" >> CHECKSUMS.txt
          echo "## Windows" >> CHECKSUMS.txt
          find . -name "ionicx-windows-*" -not -name "*.sha256" | sort >> CHECKSUMS.txt
          
          cd ..

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ env.RELEASE_TAG }}
          generate_release_notes: true
          files: |
            release-assets/*
          body: |
            ## üì• Download ionicX ${{ env.RELEASE_TAG }}
            
            ### üçé macOS
            - **ARM64 (Apple Silicon)**: `ionicx-macos-arm64.dmg`
            - **x64 (Intel)**: `ionicx-macos-x64.dmg`
            
            ### üêß Linux
            - **x86_64**: `ionicx-linux-x86_64.AppImage` or `.deb`
            - **ARM64**: `ionicx-linux-arm64.AppImage` or `.deb`
            
            ### ü™ü Windows
            - **x64**: `ionicx-windows-x64.exe` or `.msi`
            
            ### ‚úÖ Verify Integrity
            All files include SHA256 checksums. Download and verify:
            ```bash
            sha256sum -c *.sha256
            ```
            
            See [all checksums](https://github.com/${{ github.repository }}/releases/download/${{ env.RELEASE_TAG }}/CHECKSUMS.txt)
